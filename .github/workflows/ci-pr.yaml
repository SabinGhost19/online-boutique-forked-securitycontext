name: CI - Build & Scan

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: read
      packages: write
      security-events: write
    strategy:
      matrix:
        service:
          - adservice
          - cartservice
          - checkoutservice
          - currencyservice
          - emailservice
          - frontend
          - loadgenerator
          - paymentservice
          - productcatalogservice
          - recommendationservice
          - shippingservice
          - shoppingassistantservice
      fail-fast: false
    
    uses: ./.github/workflows/reusable-build.yaml
    with:
      service: ${{ matrix.service }}
      context_dir: ./src/${{ matrix.service }}
      dockerfile: ${{ matrix.service == 'cartservice' && 'src/Dockerfile' || 'Dockerfile' }}
    secrets: inherit

  # ===========================================================================
  # DEPLOY JOB (GitOps Write-Back)
  # ===========================================================================
  # This job runs ONLY on push to 'main' (not on PRs) and only if builds succeeded.
  # It calls the reusable deploy workflow.
  # ===========================================================================
  deploy:
    needs: build
    # Only run on push to main
    ##disable this for now, for debugging purpose
    #if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/reusable-deploy.yaml
    secrets: inherit
